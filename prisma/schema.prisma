// Prisma schema for Zenith AI with MongoDB

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  clerkId       String    @unique
  email         String    @unique
  password      String?   // Legacy field, no longer used with Clerk
  name          String?
  age           Int?
  disciplineLevel String? // "chaos" | "inconsistent" | "soldier" | "master"
  painPoints    String[]  // e.g. ["procrastination", "digital_distractions", ...]
  painPointsOther String?
  vision        String[]  // e.g. ["athletic_physique", "business_launched", ...]
  visionCustom  String?
  pactText      String?
  onboardingCompleted Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions      Session[]
  dailyTracking DailyTracking[]
  challenges    Challenge[]
  customTrackers CustomTracker[]
  customProtocols CustomProtocol[]

  stripeCustomerId       String?   @unique @map(name: "stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map(name: "stripe_subscription_id")
  stripePriceId          String?   @map(name: "stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map(name: "stripe_current_period_end")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model DailyTracking {
  id                    String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                String   @db.ObjectId
  date                  DateTime
  
  // SAVERS
  saversSilence         Boolean  @default(false)
  saversAffirmations    Boolean  @default(false)
  saversVisualization   Boolean  @default(false)
  saversExercise        Boolean  @default(false)
  saversReading         Boolean  @default(false)
  saversScribing        Boolean  @default(false)
  
  // Vices
  viceFreeCoke          Boolean  @default(false)
  viceFreeBeer          Boolean  @default(false)
  viceFreePorn          Boolean  @default(false)
  viceFreeSns           Boolean  @default(false)
  viceFreeWeed          Boolean  @default(false)
  
  // Additional fields
  dailyAffirmation      String?
  notes                 String?
  moodRating            Int?
  energyLevel           Int?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model AffirmationCache {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  date      DateTime @unique
  content   String
  source    String   @default("openai") // openai, manual, default
  createdAt DateTime @default(now())
}

model Challenge {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  title        String
  description  String?
  durationDays Int
  startDate    DateTime
  endDate      DateTime
  status       String   @default("active") // active, completed, failed, archived
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  checkIns     ChallengeCheckIn[]
  
  @@index([userId])
  @@index([status])
}

model ChallengeCheckIn {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  challengeId String   @db.ObjectId
  date        DateTime
  status      String   @default("success") // success, fail, skip
  notes       String?
  createdAt   DateTime @default(now())
  
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  @@unique([challengeId, date])
  @@index([challengeId])
}

model CustomTracker {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  color     String?  @default("#6366f1")
  icon      String?  @default("ðŸ“Š")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries   CustomTrackerEntry[]
  
  @@unique([userId, title])
  @@index([userId])
}

model CustomTrackerEntry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  trackerId String   @db.ObjectId
  date      DateTime
  amount    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  tracker   CustomTracker @relation(fields: [trackerId], references: [id], onDelete: Cascade)
  
  @@unique([trackerId, date])
  @@index([trackerId])
  @@index([date])
}

model CustomProtocol {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  icon      String?  @default("âœ…")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries   CustomProtocolEntry[]
  
  @@unique([userId, title])
  @@index([userId])
}

model CustomProtocolEntry {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  protocolId String   @db.ObjectId
  date       DateTime
  completed  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  protocol   CustomProtocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  
  @@unique([protocolId, date])
  @@index([protocolId])
  @@index([date])
}
